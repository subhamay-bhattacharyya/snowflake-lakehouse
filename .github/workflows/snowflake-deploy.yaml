name: â„ï¸ Snowflake DDL Deployment
run-name: Deploy Snowflake Objects to ${{ github.ref_name }} by @${{ github.actor }}

on:
  # push:
  #   branches:
  #     - main
  #     - develop
  #   paths:
  #     - 'snowflake/**'
  # pull_request:
  #   branches:
  #     - main
  #     - develop
  #   paths:
  #     - 'snowflake/**'
  workflow_dispatch:

jobs:
  find-sql-files:
    name: Find SQL Files
    runs-on: ubuntu-latest
    outputs:
      warehouse_files: ${{ steps.find.outputs.warehouse_files }}
      database_files: ${{ steps.find.outputs.database_files }}
      table_files: ${{ steps.find.outputs.table_files }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Find SQL Files
        id: find
        run: |
          # Find warehouse files
          WAREHOUSE_FILES=$(find snowflake/02_warehouses -name "*.sql" -type f 2>/dev/null | jq -R -s -c 'split("\n")[:-1]' || echo '[]')
          echo "warehouse_files=$WAREHOUSE_FILES" >> $GITHUB_OUTPUT
          
          # Find database files
          DATABASE_FILES=$(find snowflake/03_databases -name "*.sql" -type f 2>/dev/null | sort | jq -R -s -c 'split("\n")[:-1]' || echo '[]')
          echo "database_files=$DATABASE_FILES" >> $GITHUB_OUTPUT
          
          # # Find table files
          # TABLE_FILES=$(find snowflake/05_schemas -name "*.sql" -type f 2>/dev/null | sort | jq -R -s -c 'split("\n")[:-1]' || echo '[]')
          # echo "table_files=$TABLE_FILES" >> $GITHUB_OUTPUT
          
          echo "Found warehouse files: $WAREHOUSE_FILES"
          echo "Found database files: $DATABASE_FILES"
          # echo "Found table files: $TABLE_FILES"
          
          # Print to GITHUB_STEP_SUMMARY
          echo "## SQL Files Found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Category | File Path |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-----------|" >> $GITHUB_STEP_SUMMARY
          
          # Add warehouse files to table
          if [ "$WAREHOUSE_FILES" != "[]" ]; then
            echo "$WAREHOUSE_FILES" | jq -r '.[]' | while read -r file; do
              echo "| Warehouse | \`$file\` |" >> $GITHUB_STEP_SUMMARY
            done
          fi
          
          # Add database files to table
          if [ "$DATABASE_FILES" != "[]" ]; then
            echo "$DATABASE_FILES" | jq -r '.[]' | while read -r file; do
              echo "| Database | \`$file\` |" >> $GITHUB_STEP_SUMMARY
            done
          fi
          
          # Add table files to table
          # if [ "$TABLE_FILES" != "[]" ]; then
          #   echo "$TABLE_FILES" | jq -r '.[]' | while read -r file; do
          #     echo "| Table | \`$file\` |" >> $GITHUB_STEP_SUMMARY
          #   done
          # fi
          
          # If no files found at all
          if [ "$WAREHOUSE_FILES" = "[]" ] && [ "$DATABASE_FILES" = "[]" ] && [ "$TABLE_FILES" = "[]" ]; then
            echo "| - | _No SQL files found_ |" >> $GITHUB_STEP_SUMMARY
          fi

  deploy-warehouses:
    name: Deploy Warehouse
    runs-on: ubuntu-latest
    needs: find-sql-files
    if: needs.find-sql-files.outputs.warehouse_files != '[]'
    strategy:
      matrix:
        sql_file: ${{ fromJson(needs.find-sql-files.outputs.warehouse_files) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Deploy ${{ matrix.sql_file }}
        uses: subhamay-bhattacharyya-gha/snowflake-run-ddl-action@feature/GHA-0001-implement-reusable-github
        with:
          account: ${{ vars.SNOWFLAKE_ACCOUNT }}
          user: ${{ vars.SNOWFLAKE_USER }}
          private_key: ${{ secrets.SNOWFLAKE_PRIVATE_KEY }}
          role: SYSADMIN
          script: ${{ matrix.sql_file }}

  deploy-databases:
    name: Deploy Database
    runs-on: ubuntu-latest
    needs: [find-sql-files, deploy-warehouses]
    if: |
      always() &&
      needs.find-sql-files.outputs.database_files != '[]' &&
      (needs.deploy-warehouses.result == 'success' || needs.deploy-warehouses.result == 'skipped')
    strategy:
      matrix:
        sql_file: ${{ fromJson(needs.find-sql-files.outputs.database_files) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Deploy ${{ matrix.sql_file }}
        uses: subhamay-bhattacharyya-gha/snowflake-run-ddl-action@feature/GHA-0001-implement-reusable-github
        with:
          account: ${{ vars.SNOWFLAKE_ACCOUNT }}
          user: ${{ vars.SNOWFLAKE_USER }}
          private_key: ${{ secrets.SNOWFLAKE_PRIVATE_KEY }}
          role: SYSADMIN
          script: ${{ matrix.sql_file }}

  # deploy-tables:
  #   name: Deploy Table
  #   runs-on: ubuntu-latest
  #   needs: [find-sql-files, deploy-databases]
  #   if: |
  #     always() &&
  #     needs.find-sql-files.outputs.table_files != '[]' &&
  #     (needs.deploy-databases.result == 'success' || needs.deploy-databases.result == 'skipped')
  #   strategy:
  #     matrix:
  #       sql_file: ${{ fromJson(needs.find-sql-files.outputs.table_files) }}
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v6
      
  #     - name: Deploy ${{ matrix.sql_file }}
  #       uses: subhamay-bhattacharyya-gha/snowflake-run-ddl-action@feature/GHA-0001-implement-reusable-github
  #       with:
  #         account: ${{ vars.SNOWFLAKE_ACCOUNT }}
  #         user: ${{ vars.SNOWFLAKE_USER }}
  #         private_key: ${{ secrets.SNOWFLAKE_PRIVATE_KEY }}
  #         script: ${{ matrix.sql_file }}

  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [find-sql-files, deploy-warehouses, deploy-databases]
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Create Migration History Query
        run: |
          cat > /tmp/query_migration_history.sql << 'EOF'
          SELECT 
            script_name,
            script_path,
            status,
            TO_CHAR(applied_at, 'YYYY-MM-DD HH24:MI:SS') as applied_at,
            actor
          FROM UTIL_DB.UTIL_SCHEMA.DDL_MIGRATION_HISTORY
          ORDER BY applied_at DESC
          LIMIT 20;
          EOF
      
      - name: Query Migration History
        id: migration_history
        uses: subhamay-bhattacharyya-gha/snowflake-run-ddl-action@feature/GHA-0001-implement-reusable-github
        continue-on-error: true
        with:
          account: ${{ vars.SNOWFLAKE_ACCOUNT }}
          user: ${{ vars.SNOWFLAKE_USER }}
          private_key: ${{ secrets.SNOWFLAKE_PRIVATE_KEY }}
          role: SYSADMIN
          script: /tmp/query_migration_history.sql
          track_migrations: false
      
      - name: Generate Deployment Summary
        run: |
          echo "# ðŸŽ¯ Snowflake Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Job Status Summary
          echo "## ðŸ“Š Job Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Find SQL Files | ${{ needs.find-sql-files.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Warehouses | ${{ needs.deploy-warehouses.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Databases | ${{ needs.deploy-databases.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Objects Deployed Summary
          echo "## ðŸ—„ï¸ Database Objects Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Count files
          WAREHOUSE_COUNT=$(echo '${{ needs.find-sql-files.outputs.warehouse_files }}' | jq '. | length')
          DATABASE_COUNT=$(echo '${{ needs.find-sql-files.outputs.database_files }}' | jq '. | length')
          TOTAL_COUNT=$((WAREHOUSE_COUNT + DATABASE_COUNT))
          
          echo "| Object Type | Count | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ­ Warehouses | $WAREHOUSE_COUNT | ${{ needs.deploy-warehouses.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—ƒï¸ Databases | $DATABASE_COUNT | ${{ needs.deploy-databases.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **$TOTAL_COUNT** | - |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Detailed File List
          echo "## ðŸ“ Deployed Scripts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Warehouses
          if [ "$WAREHOUSE_COUNT" -gt 0 ]; then
            echo "### ðŸ­ Warehouses ($WAREHOUSE_COUNT)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '${{ needs.find-sql-files.outputs.warehouse_files }}' | jq -r '.[]' | while read -r file; do
              echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Databases
          if [ "$DATABASE_COUNT" -gt 0 ]; then
            echo "### ðŸ—ƒï¸ Databases ($DATABASE_COUNT)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '${{ needs.find-sql-files.outputs.database_files }}' | jq -r '.[]' | while read -r file; do
              echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Migration History
          echo "## ðŸ“œ Migration History (Last 20 Deployments)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.migration_history.outcome }}" == "success" ]; then
            echo "| Script Name | Path | Status | Applied At | Actor |" >> $GITHUB_STEP_SUMMARY
            echo "|-------------|------|--------|------------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "_Query executed successfully. Check action logs for detailed results._" >> $GITHUB_STEP_SUMMARY
          else
            echo "_Migration history table not available or query failed. This is normal for first-time deployments._" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall Status
          echo "## âœ… Overall Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.deploy-warehouses.result }}" == "success" ] || [ "${{ needs.deploy-warehouses.result }}" == "skipped" ]; then
            if [ "${{ needs.deploy-databases.result }}" == "success" ] || [ "${{ needs.deploy-databases.result }}" == "skipped" ]; then
              echo "âœ… **Deployment completed successfully!**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "All database objects have been deployed to Snowflake." >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **Deployment failed at database stage**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Database deployment failed. Check the logs above." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **Deployment failed at warehouse stage**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Warehouse deployment failed. Check the logs above." >> $GITHUB_STEP_SUMMARY
          fi
